<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
<title>REST CRUD</title>
<link rel="stylesheet" type="text/css" href="crud.css">
<script src="scripts/prototype.js"></script>
<script>
var baseurl = 'http://localhost:8080/joymeter-webapi/webresources/users';
var PREAMBLE = '<div id="deleteOptions"><table class="tableone" summary="This table lists users in the database."> <caption>Users In Database</caption>';
PREAMBLE +='<thead> <tr>';
PREAMBLE +='<th class="th1" scope="col">&nbsp;&nbsp;&nbsp;&nbsp;</th> <th class="th2" scope="col">Name</th> <th class="th3" scope="col">Email</th> <th class="th4" scope="col">Facebook Account</th> <th class="th5" scope="col">Sesion Token</th> <th class="th6" scope="col">Creation Date</th> <th class="th7" scope="col">Update</th></tr>';
PREAMBLE +='</thead><tfoot> <tr> <td colspan="5">Check items for deletion.</td> </tr> </tfoot> <tbody> <tr><td colspan="4"> <div class="innerb">';
PREAMBLE +='<table class="tabletwo"><tbody>';
var POSTAMBLE='</tbody></table>';
var tempateText='<tr><th class="td1" scope="row"><input type="checkbox" id="#{id}"/></th><td class="td2">#{name}</td><td class="td3">#{email}</td><td class="td4">#{facebook_account}</td><td class="td5">#{sesion_token}</td><td class="td6">#{creation_date}</td><td class="td7"><input type="button" value="Update"onClick=" populateUser(\'#{id}\',\'#{name}\',\'#{email}\,\'#{facebook_account}\',\'#{sesion_token}\',\'#{creation_date}\');"/></td></tr>';


// This would make more sense to use not causing another network transaction but we will use the one below
// to test the get id functionality of our service.
function populateUserInPage(id,name,email,facebookAccount,sesionToken,creationDate) {
	$('theId').value=id;
	$('name').value=name;
	$('email').value=email;
	$('facebook_account').value=facebookAccount;
	$('sesion_token').value=sesionToken;
	$('creation_date').value=creationDate;
	$('updateAdd').value = "Update User";
}

function populateUser(id,name,email,facebookAccount,sesionToken,creationDate) {
	new Ajax.Request(baseurl+'/'+id,
			  {
			    method:'get',
			    onSuccess: function(transport){
	    			try{
					  var json = transport.responseText.evalJSON();
					  	$('theId').value= json.id;
						$('name').value= json.name;
						$('email').value= json.email;
						$('facebook_account').value= json.facebookAccount;
						$('sesion_token').value= json.sesionToken;
						$('creation_date').value= json.creationDate;
						$('updateAdd').value = "Update User";
	 		  		 } catch(err) {
	    				  txt="There was an error on this page.\n\n";
	    				  txt+="Error description: " + err.description + "\n\n";
	    				  txt+="Click OK to continue.\n\n";
	    				  alert(txt);
	    			  }
			   },
			    onFailure: function(){ alert('Something went wrong...') }
			  });
}


function clear() {
	$('theId').value='';
	$('name').value= '';
	$('email').value= '';
	$('facebook_account').value= '';
	$('sesion_token').value= '';
	$('creation_date').value= '';
	$('updateAdd').value = "Add User";
}

function deleteUsers()
{
	var someNodeList = $('deleteOptions').getElementsByTagName('input');
	var nodes = $A(someNodeList);

	if(nodes.length < 1 ) {
		alert("Select user to delete");
		return;
	}
	var parameters = new Array();
	var count = 0;
	var additionalids = '';
	var firstId;
	nodes.each(function(node){
			if( (node.id != null)&&(node.checked) ) {
				if(count == 0) {
					firstId = node.id;
				} 
				if(count > 0) {
				//	if(count>1) {
				//		additionalids +=",";
				//	} 
				//	additionalids += node.id;
					if(count>1) {
						additionalids +="&";
					} 
					additionalids += 'id='+node.id;
				}
				count++
			}
		});

   new Ajax.Request(baseurl+'/'+firstId,
			  {
			    method:'delete',
			  //  parameters:'additionalids='+additionalids,
			  parameters:additionalids,
			    onSuccess: function(transport){
	    			var reply = transport.responseText;
	    			getUsers();
			   },
			    onFailure: function(){ alert('Something went wrong...') }
			  });
   clear();
}

function getUsers() {
	new Ajax.Request(baseurl,
			  {
			    method:'get',
			    onSuccess: function(transport){
	    			try{
					  var json = transport.responseText.evalJSON();
					  var rowItem = new Template(tempateText);
					  var formatted = PREAMBLE;
				
					json.users.each(function(user){formatted += rowItem.evaluate(user);})
					formatted += POSTAMBLE;
					$('result').innerHTML = formatted; 
	 		  		 } catch(err) {
	    				  txt="There was an error on this page.\n\n";
	    				  txt+="Error description: " + err.description + "\n\n";
	    				  txt+="Click OK to continue.\n\n";
	    				  alert(txt);
	    			  }
			   },
			    onFailure: function(){ alert('Something went wrong...') }
			  });

}

function addUser() {
	var name= $('name').value;
	var email= $('email').value;
	var facebook_account= $('facebook_account').value;
	var sesion_token = $('sesion_token').value;
	var creation_date= $('creation_date').value;
	var anId  = $('theId').value;
	var method;
	var parameters;
	
	if($('updateAdd').value == "Update User"){
		method='put';
		parameters = 'id='+anId+'&name='+name+"&email="+email+"&facebook_account="+facebook_account+"&sesion_token="+sesion_token+"&creation_date="+creation_date;
	} else {
		method='post';
		parameters = 'name='+name+"&email="+email+"&facebook_account="+facebook_account+"&sesion_token="+sesion_token+"&creation_date="+creation_date;
	}

	new Ajax.Request(baseurl,
			  {
			    method:method,
			    parameters:parameters,
			    onSuccess: function(transport){
					getUsers();
					clear();
			   },
			    onFailure: function(){ alert('Something went wrong...') }
			  });

}

function clearit()
{
	
	var myAjax = new Ajax.Request(baseurl,
				{
					method: 'get',
					parameters:'clear=clear',
					onSuccess: function(transport){
					clear();
				}, 
					onFailure: function reportError(request)
					{
						alert('Sorry. There was an error.');
					}
				});
	
}

</script>

</head>
<body onload="return getUsers()">
<div id="container">
<div id="top">
<h1>REST: CRUD Sample</h1>

<h2>Utilizing: Jersey, Spring, JPA and Hibernate&nbsp;</h2>
</div>

<table summary="Outter table">
	<tr>
		<td>
		<div id="input">
		<table>
			<tbody>
				<tr>
					<td><label>Name:</label></td>
					<td><input id="name" type="text"></td>
				</tr>
				<tr>
					<td><label>Email:</label></td>
					<td><input id="email" type="text"></td>
				</tr>
				<tr>
					<td><label>Facebook Account:</label></td>
					<td><input id="facebook_account" type="text"></td>
				</tr>
				<tr>
					<td><label>Sesion Token:</label></td>
					<td><input id="sesion_token" type="text"></td>
				</tr>
				<tr>
					<td><label>Creation Date:</label></td>
					<td><input id="creation_date" type="text"></td>
				</tr>
				<tr>
					<td><label>Id:</label></td>
					<td><input id="theId" disabled="disabled" type="text"></td>
				</tr>
				<tr>
					<td><input value="Clear" onclick="clearit();" type="button">
					</td>
					<td><input value="Add User" id="updateAdd"
						onclick="addUser();" type="button"></td>
				</tr>
			</tbody>
		</table>
		</div>
		</td>
		<td>
		<div id="plist">
		<div id="result"></div>
		</div>
		<div id="deleteDiv"><input type="button" value="Delete"
			onClick="deleteUsers();" /></div>
		</td>
	</tr>
</table>
<div id="footer"><a href="http://www.persistentdesigns.com">Persistent
Designs Inc.</a></div>
</div>
</body>
</html>
